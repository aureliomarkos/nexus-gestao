<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus GCI - Dashboard Administrativo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (Ícones modernos) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Estilos customizados para a fonte e transições */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* blue-50 */
            text-size-adjust: 100%;
        }
        .sidebar {
            transition: width 0.3s ease;
        }
        .content {
            transition: margin-left 0.3s ease;
        }
        .input-field {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            width: 100%;
        }
        .input-field:focus {
            border-color: #f97316; /* orange-500 */
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            outline: none;
        }
        /* Cor primária Laranja */
        .primary-bg { background-color: #ea580c; /* orange-700 */ }
        .primary-hover-bg:hover { background-color: #c2410c; /* orange-800 */ }
        .primary-text { color: #ea580c; }
        .active-tab { background-color: #c2410c; } /* orange-800 */
        .sidebar-header-bg { background-color: #9a3412; } /* orange-900 */
    </style>
</head>
<body>

    <!-- Variável Global de Configuração da API -->
    <script>
        // *** IMPORTANTE ***: Defina a URL base do seu servidor FastAPI aqui.
        const API_BASE_URL = "http://127.0.0.1:8000"; 
    </script>

    <script>
        // Protege o dashboard: se não houver token, redireciona para a página de login
        (function ensureAuthenticated() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    // redireciona para a página de login
                    window.location.href = './login.html';
                }
            } catch (e) {
                // Em caso de erro no acesso ao localStorage, redireciona também
                window.location.href = './login.html';
            }
        })();
    </script>

    <div id="app" class="flex min-h-screen">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar sidebar-header-bg text-white w-64 flex flex-col fixed h-full z-20">
            <div class="p-6 text-2xl font-extrabold text-white shadow-lg sidebar-header-bg">
                Nexus Admin
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-orange-700 transition duration-150 active-tab" data-tab="desenvolvedores">
                    <i data-lucide="code" class="w-5 h-5 mr-3"></i>
                    Desenvolvedores
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-orange-700 transition duration-150" data-tab="clientes">
                    <i data-lucide="briefcase" class="w-5 h-5 mr-3"></i>
                    Clientes
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-orange-700 transition duration-150" data-tab="projetos">
                    <i data-lucide="kanban" class="w-5 h-5 mr-3"></i>
                    Projetos
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-lg hover:bg-orange-700 transition duration-150" data-tab="infraestrutura">
                    <i data-lucide="server" class="w-5 h-5 mr-3"></i>
                    Infraestrutura
                </a>
            </nav>
            <div class="p-4 border-t border-orange-700">
                <p class="text-xs text-orange-300">FastAPI & Tailwind</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="content flex-1 ml-64 p-4 sm:p-8">
            <!-- Header/Top Bar -->
            <header class="mb-8 pb-4 border-b-2 border-orange-200 sticky top-0 bg-white z-10">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <h1 id="page-title" class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Desenvolvedores</h1>
                    <div class="flex items-center space-x-4">
                        <div id="view-toggle-container" class="flex">
                            <button id="toggle-grid" class="view-toggle flex items-center primary-bg text-white px-3 py-1 rounded-l-lg text-sm font-semibold shadow-md transition duration-300">
                                <i data-lucide="grid" class="w-4 h-4 mr-1"></i> Grid
                            </button>
                            <button id="toggle-table" class="view-toggle flex items-center bg-gray-200 text-gray-700 px-3 py-1 rounded-r-lg text-sm font-semibold shadow-md transition duration-300 hover:bg-gray-300">
                                <i data-lucide="table" class="w-4 h-4 mr-1"></i> Tabela
                            </button>
                        </div>
                        <button id="add-new-btn" class="flex items-center primary-bg text-white px-4 py-2 rounded-lg font-semibold shadow-md primary-hover-bg transition duration-300">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                            Adicionar Novo
                        </button>
                        <button id="logout-btn" title="Sair" class="flex items-center bg-gray-100 text-gray-800 px-3 py-2 rounded-lg font-medium hover:bg-gray-200 transition duration-200">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </header>

            <!-- Alerta de Mensagens -->
            <div id="alert-container" class="mb-4"></div>

            <!-- Indicador de Carregamento -->
            <div id="loading-indicator" class="hidden flex items-center justify-center p-12 text-gray-600 bg-white rounded-xl shadow">
                <i data-lucide="loader-2" class="w-6 h-6 mr-2 animate-spin text-orange-600"></i>
                <span>Carregando dados...</span>
            </div>

            <!-- Conteúdo Dinâmico por Aba -->
            <div id="tab-content">
                <!-- Conteúdo das listas será injetado aqui -->
                <section id="tab-desenvolvedores" class="module-content">
                    <div id="dev-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </section>
                <section id="tab-clientes" class="module-content hidden">
                    <div id="client-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </section>
                <section id="tab-projetos" class="module-content hidden">
                    <div id="project-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </section>
                <section id="tab-infraestrutura" class="module-content hidden">
                    <div id="infra-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                </section>
            </div>
        </main>
    </div>

    <!-- MODAL PRINCIPAL REUTILIZÁVEL (CRUD) -->
    <div id="main-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl p-6 relative overflow-y-auto max-h-[90vh]">
            <h2 id="modal-title" class="text-2xl font-semibold primary-text mb-6 border-b pb-3">Adicionar/Editar Item</h2>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition text-3xl">&times;</button>
            
            <form id="item-form" class="space-y-6">
                <!-- Conteúdo do Formulário será injetado aqui pelo JS -->
                <div id="form-fields-container"></div>
                
                <button type="submit" id="submit-form-btn" class="w-full primary-bg primary-hover-bg text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center mt-6">
                    <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                    <span id="submit-form-text">Salvar Item</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmação para Exclusão (Customizado) -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 relative text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Confirmação de Exclusão</h3>
            <p id="confirm-modal-text" class="text-gray-700 mb-6">Tem certeza que deseja excluir <span class="font-bold"></span>? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="execute-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Excluir</button>
            </div>
        </div>
    </div>

    <script>
        // --- Referências de Elementos do DOM ---
        const pageTitle = document.getElementById('page-title');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.module-content');
        const alertContainer = document.getElementById('alert-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const addDevBtn = document.getElementById('add-new-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const viewToggleContainer = document.getElementById('view-toggle-container');
        const toggleGridBtn = document.getElementById('toggle-grid');
        const toggleTableBtn = document.getElementById('toggle-table');
        
        const mainModal = document.getElementById('main-modal');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const itemForm = document.getElementById('item-form');
        const formFieldsContainer = document.getElementById('form-fields-container');
        const submitFormText = document.getElementById('submit-form-text');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const executeDeleteBtn = document.getElementById('execute-delete-btn');

        // --- Variáveis de Estado ---
        let currentTab = 'desenvolvedores';
        let currentView = 'grid'; // 'grid' ou 'table'
        let editingItemId = null; 
        let itemToDelete = { id: null, nome: null, endpoint: null, containerId: null };

        // --- Mapeamento de Módulos (Baseado no arquivo instruções gerar dashboard-admin.txt) ---
        const MODULE_MAP = {
            desenvolvedores: { 
                endpoint: 'desenvolvedores', // Note: Sem barra inicial
                containerId: 'dev-list-container', 
                pk: 'id_desenvolvedor',
                singular: 'Desenvolvedor',
                formFields: [
                    { label: "Nome", sql: "nome", type: "text", required: true },
                    { label: "Email", sql: "email", type: "email", required: true },
                    { label: "Telefone", sql: "telefone", type: "text" },
                    { label: "Documento Fiscal (CPF/CNPJ)", sql: "documento_fiscal", type: "text" },
                    { label: "Contrato", sql: "tipo_contrato", type: "select", options: ["CLT", "PJ", "Freelancer"] },
                    { label: "Taxa Horária (R$)", sql: "taxa_horaria", type: "number", step: "0.01", value: "0.00" },
                ],
                addressFields: true
            },
            clientes: {
                endpoint: 'clientes', 
                containerId: 'client-list-container', 
                pk: 'id_cliente',
                singular: 'Cliente',
                formFields: [
                    { label: "Nome", sql: "nome", type: "text", required: true },
                    { label: "Email", sql: "email", type: "email" },
                    { label: "Telefone", sql: "telefone", type: "text" },
                    { label: "Pessoa Contato", sql: "pessoa_contato", type: "text" },
                    { label: "Documento Fiscal", sql: "documento_fiscal", type: "text" },
                    { label: "Status Relacionamento", sql: "status_relacionamento", type: "text"  },
                    { label: "Segmento", sql: "segmento", type: "text" },
                    { label: "Origem", sql: "origem", type: "text" },
                    { label: "Observações", sql: "observacoes", type: "textarea" },
                ],
                addressFields: true
            },
            infraestrutura: {
                endpoint: 'infra', 
                containerId: 'infra-list-container', 
                pk: 'id_item',
                singular: 'Item de Infraestrutura',
                formFields: [
                    { label: "Cliente Responsável", sql: "id_cliente", type: "select", required: true, remoteOptions: { endpoint: 'clientes', valueKey: 'id_cliente', labelKey: 'nome' } }, // NOVO CAMPO
                    { label: "Desenvolvedor Suporte", sql: "id_desenvolvedor", type: "select", remoteOptions: { endpoint: 'desenvolvedores', valueKey: 'id_desenvolvedor', labelKey: 'nome' } }, // NOVO CAMPO
                    { label: "Tipo Ítem", sql: "tipo_item", type: "text", required: true },
                    { label: "Descrição", sql: "descricao", type: "text" },
                    { label: "URL Acesso", sql: "url_acesso", type: "url" },
                    { label: "Usuário", sql: "usuario", type: "text" },
                    { label: "Referência Senha", sql: "referencia_senha", type: "text", notes: "Não armazenar a senha em texto puro, apenas referência" },
                    { label: "Crítico", sql: "is_critico", type: "checkbox" },
                    { label: "Data Expiração", sql: "data_expiracao", type: "date" },
                    { label: "Notas de Acesso", sql: "notas_acesso", type: "textarea" },
                ],
                addressFields: false
            },
            projetos: {
                endpoint: 'projetos', 
                containerId: 'project-list-container', 
                pk: 'id_servico',
                singular: 'Projeto/Serviço',
                formFields: [
                    { label: "Cliente", sql: "id_cliente", type: "select", required: true, remoteOptions: { endpoint: 'clientes', valueKey: 'id_cliente', labelKey: 'nome' } }, // NOVO CAMPO
                    { label: "Desenvolvedor Líder", sql: "id_desenvolvedor", type: "select", required: true, remoteOptions: { endpoint: 'desenvolvedores', valueKey: 'id_desenvolvedor', labelKey: 'nome' } }, // NOVO CAMPO
                    { label: "Título", sql: "titulo", type: "text", required: true },
                    { label: "Escopo", sql: "escopo", type: "textarea" },
                    { label: "Estado do Projeto", sql: "status_projeto", type: "select", options: ["Em Andamento", "Concluído", "Pendente", "Cancelado"] },
                    { label: "Data Início", sql: "data_inicio", type: "date" },
                    { label: "Data Limite", sql: "data_limite", type: "date" },
                    { label: "Orçamento (R$)", sql: "orcamento", type: "number", step: "0.01", value: "0.00" },
                    { label: "Notas Internas", sql: "notas_internas", type: "textarea" },
                ],
                addressFields: false
            }
        };

        // --- FUNÇÕES DE UTILIDADE ---

        /**
         * Exibe uma mensagem de alerta na UI (substitui alert()).
         */
        const showAlert = (message, type = 'error') => {
            const colors = {
                success: { bg: 'bg-green-100', border: 'border-green-500', text: 'text-green-700' },
                error: { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-700' },
                warning: { bg: 'bg-yellow-100', border: 'border-yellow-500', text: 'text-yellow-700' }
            };
            const style = colors[type] || colors.error;

            const alertHtml = `
                <div class="${style.bg} border-l-4 ${style.border} ${style.text} p-4 mb-4 rounded-lg flex justify-between items-center" role="alert">
                    <p class="font-medium">${message}</p>
                    <button onclick="this.parentNode.remove()" class="font-bold text-lg leading-none">&times;</button>
                </div>
            `;
            alertContainer.innerHTML = alertHtml;
            setTimeout(() => {
                if (alertContainer.firstChild) {
                    alertContainer.firstChild.remove();
                }
            }, 5000);
        };

        /**
         * Função genérica para chamadas de API (AGORA USANDO FETCH REAL).
         */
        const apiCall = async (endpoint, config = {}) => {
            
            loadingIndicator.classList.remove('hidden');
            
            const url = `${API_BASE_URL}/${endpoint}`;
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            };

            // Se existir token no localStorage, envia no header Authorization
            try {
                const token = localStorage.getItem('access_token');
                if (token) headers['Authorization'] = `Bearer ${token}`;
            } catch (e) {
                // ignore localStorage errors
            }

            try {
                const response = await fetch(url, { ...config, headers });
                
                if (!response.ok) {
                    // Tenta ler o erro do corpo da resposta, se disponível
                    const errorText = await response.text();
                    let errorMessage = `Erro HTTP ${response.status} ao acessar ${url}`;
                    
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorJson.message || errorMessage;
                    } catch (e) {
                        // Se não for JSON, usa o status e URL
                        errorMessage = `${errorMessage}. Corpo da Resposta: ${errorText.substring(0, 100)}...`;
                    }
                    
                    throw new Error(errorMessage);
                }

                // Respostas DELETE e PUT sem corpo podem retornar 204 No Content
                if (response.status === 204 || config.method === 'DELETE') {
                    return { success: true, message: "Operação bem-sucedida" };
                }

                return await response.json();

            } catch (error) {
                console.error("Erro na chamada de API:", error.message);
                showAlert(`Falha na API: ${error.message}`, 'error');
                throw error;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        };

        /**
         * Busca dados da API e preenche um campo SELECT no modal.
         */
    const fillRemoteSelect = async (fieldConfig, selectedValue) => {
    const { sql, remoteOptions } = fieldConfig;
    const selectElement = itemForm.querySelector(`[name="${sql}"]`);

    console.log(`[LOG-FILL] Tentando preencher campo ${fieldConfig.label} do endpoint: /${remoteOptions.endpoint}`); // LOG 1
    if (!selectElement || !remoteOptions) return;
    
    selectElement.innerHTML = `<option value="" disabled selected>Carregando ${fieldConfig.label}...</option>`;
    selectElement.disabled = true;

    try {
        const items = await apiCall(remoteOptions.endpoint, { method: 'GET' });
        console.log(`[LOG 14 - DADOS BRUTOS] ${fieldConfig.label}:`, items);

        if (!Array.isArray(items)) {
             throw new Error('Resposta da API não é um Array (Lista de itens).');
        }
        
        console.log(`[LOG-FILL] Sucesso ao carregar ${items.length} itens para ${fieldConfig.label}.`); // LOG 2
        
        let optionsHtml = `<option value="" disabled ${!selectedValue ? 'selected' : ''}>Selecione um ${fieldConfig.label}</option>`;
        
        items.forEach(item => {
            const value = item[remoteOptions.valueKey];
            // Tenta labelKey, depois campos comuns, depois qualquer string disponível
            let label = item[remoteOptions.labelKey] || item.nome || item.email;
            if (!label) {
                const firstString = Object.values(item).find(v => typeof v === 'string' && v.trim().length > 0);
                label = firstString || '';
            }
            if (!label) {
                console.warn(`[LOG-FILL] item sem rótulo encontrado para ${fieldConfig.label}:`, item);
                label = 'Sem nome';
            }
            const isSelected = selectedValue == value ? 'selected' : ''; 
            optionsHtml += `<option value="${value}" ${isSelected}>${label}</option>`;
        });
        
        selectElement.innerHTML = optionsHtml;
        selectElement.disabled = false;

    } catch (error) {
        console.error(`[LOG-FILL] ERRO FATAL ao carregar opções para ${fieldConfig.label}:`, error); // LOG 3
        selectElement.innerHTML = `<option value="" selected>Erro ao carregar opções</option>`;
        selectElement.disabled = true;
        throw error;
    }
    };
        // --- FUNÇÕES DE RENDERIZAÇÃO DE LISTA ---

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            try {
                // Formato ISO 8601 para Date
                const date = new Date(dateString);
                // Verifica se a data é válida
                if (isNaN(date)) return dateString; 
                return date.toLocaleDateString('pt-BR');
            } catch {
                return dateString;
            }
        };

        const getBadge = (text, type = 'status') => {
            let color = 'bg-gray-200 text-gray-700';
            if (type === 'status') {
                if (text === 'CLT' || text === 'Em Andamento') color = 'bg-orange-100 text-orange-800';
                else if (text === 'PJ' || text === 'Concluído') color = 'bg-green-100 text-green-800';
                else if (text === 'Pendente' || text === 'Freelancer') color = 'bg-yellow-100 text-yellow-800';
                else if (text === 'Cancelado') color = 'bg-red-100 text-red-800';
            } else if (type === 'critico') {
                 color = text ? 'bg-red-600 text-white' : 'bg-gray-400 text-white';
            }
            return `<span class="px-2 py-0.5 rounded-full text-xs font-medium ${color}">${text}</span>`;
        };

        const renderCard = (item, module) => {
            const moduleInfo = MODULE_MAP[module];
            // O ID deve ser recuperado usando a chave primária do módulo
            const id = item[moduleInfo.pk] || 'undefined'; 
            const address = item.endereco_obj || {};
            const localidade = (address.cidade && address.estado) ? `${address.cidade}, ${address.estado}` : 'N/A';
            const primaryName = item.nome || item.titulo || item.descricao || `Item ${id}`;
            let details = '';
            let icon = 'code'; // Desenvolvedores padrão

            if (module === 'desenvolvedores') {
                const contractBadge = getBadge(item.tipo_contrato || 'N/A', 'status');
                icon = 'code';
                details = `
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Contrato:</span> ${contractBadge}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Taxa/h:</span> R$ ${item.taxa_horaria !== undefined ? parseFloat(item.taxa_horaria).toFixed(2) : '0.00'}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Email:</span> ${item.email || 'N/A'}</p>
                `;
            } else if (module === 'clientes') {
                icon = 'briefcase';
                details = `
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Segmento:</span> ${item.segmento || 'N/A'}</p>
                    <p class="text-gray-700 truncate"><span class="font-semibold w-20 inline-block">Contato:</span> ${item.pessoa_contato || 'N/A'}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Origem:</span> ${item.origem || 'N/A'}</p>
                `;
            } else if (module === 'infraestrutura') {
                // assume item.is_critico é um booleano
                const isCriticoBadge = getBadge(item.is_critico ? 'CRÍTICO' : 'Normal', 'critico');
                icon = 'server';
                details = `
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Tipo:</span> ${item.tipo_item || 'N/A'}</p>
                    <p class="text-gray-700 truncate"><span class="font-semibold w-20 inline-block">Usuário:</span> ${item.usuario || 'N/A'}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Expira:</span> ${formatDate(item.data_expiracao)}</p>
                    <div class="mt-2 flex items-center justify-between">
                        <span class="font-semibold text-sm">Criticidade:</span> ${isCriticoBadge}
                    </div>
                `;
            } else if (module === 'projetos') {
                const statusBadge = getBadge(item.status_projeto || 'N/A', 'status');
                icon = 'kanban';
                details = `
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Status:</span> ${statusBadge}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Início:</span> ${formatDate(item.data_inicio)}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Limite:</span> ${formatDate(item.data_limite)}</p>
                    <p class="text-gray-700"><span class="font-semibold w-20 inline-block">Orçamento:</span> R$ ${item.orcamento !== undefined ? parseFloat(item.orcamento).toFixed(2) : '0.00'}</p>
                `;
            }

            return `
                <div class="bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border border-orange-100 flex flex-col" data-item-id="${id}" data-item-module="${module}">
                    <div class="flex items-center mb-3">
                        <i data-lucide="${icon}" class="w-6 h-6 mr-3 primary-text flex-shrink-0"></i>
                        <h3 class="text-xl font-bold text-gray-800 truncate">${primaryName}</h3>
                    </div>
                    
                    <div class="space-y-2 text-sm flex-grow">
                        ${details}
                    </div>

                    ${moduleInfo.addressFields ? 
                        `<p class="flex items-start text-gray-500 text-xs pt-2 border-t border-orange-50 mt-2">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0 primary-text"></i>
                            <span>${localidade}</span>
                        </p>` : ''
                    }

                    <div class="mt-4 pt-3 border-t border-gray-100 flex justify-end space-x-2">
                        <button class="edit-btn text-orange-500 hover:text-orange-700 text-sm font-medium" data-item-id="${id}" data-item-name="${primaryName}">Editar</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 text-sm font-medium" data-item-id="${id}" data-item-name="${primaryName}">Apagar</button>
                    </div>
                </div>
            `;
        };
        
        const renderTable = (items, module) => {
            if (!Array.isArray(items) || items.length === 0) return '';
            
            let headers = [];
            let rows = '';

            // Definindo headers baseados no módulo
            if (module === 'desenvolvedores') {
                headers = ['Nome', 'Email', 'Contrato', 'Taxa/h', 'Localidade', 'Ações'];
                items.forEach(item => {
                    const address = item.endereco_obj || {};
                    const localidade = (address.cidade && address.estado) ? `${address.cidade}/${address.estado}` : 'N/A';
                    rows += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${getBadge(item.tipo_contrato || 'N/A', 'status')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${item.taxa_horaria !== undefined ? parseFloat(item.taxa_horaria).toFixed(2) : '0.00'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${localidade}</td>
                        ${renderActionButtons(item.id_desenvolvedor, item.nome)}
                    </tr>`;
                });
            } else if (module === 'clientes') {
                headers = ['Nome', 'Contato', 'Email', 'Segmento', 'Localidade', 'Ações'];
                items.forEach(item => {
                    const address = item.endereco_obj || {};
                    const localidade = (address.cidade && address.estado) ? `${address.cidade}/${address.estado}` : 'N/A';
                    rows += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.pessoa_contato || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.segmento || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${localidade}</td>
                        ${renderActionButtons(item.id_cliente, item.nome)}
                    </tr>`;
                });
            } else if (module === 'infraestrutura') {
                headers = ['Tipo Ítem', 'Descrição', 'Usuário', 'Data Expiração', 'Crítico', 'Ações'];
                items.forEach(item => {
                    rows += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.tipo_item}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.descricao.substring(0, 30)}${item.descricao.length > 30 ? '...' : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.usuario || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.data_expiracao)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${getBadge(item.is_critico ? 'SIM' : 'NÃO', 'critico')}</td>
                        ${renderActionButtons(item.id_item, item.descricao)}
                    </tr>`;
                });
            } else if (module === 'projetos') {
                headers = ['Título', 'Status', 'Início', 'Limite', 'Orçamento', 'Ações'];
                items.forEach(item => {
                    rows += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.titulo}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${getBadge(item.status_projeto, 'status')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.data_inicio)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.data_limite)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R$ ${item.orcamento !== undefined ? parseFloat(item.orcamento).toFixed(2) : '0.00'}</td>
                        ${renderActionButtons(item.id_servico, item.titulo)}
                    </tr>`;
                });
            }

            return `
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                ${headers.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${rows}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        const renderActionButtons = (id, name) => {
            // Garante que o ID é uma string, crucial para data-attributes
            const itemId = String(id); 
            return `<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                <button class="edit-btn text-orange-500 hover:text-orange-700" data-item-id="${itemId}" data-item-name="${name}">Editar</button>
                <button class="delete-btn text-red-500 hover:text-red-700" data-item-id="${itemId}" data-item-name="${name}">Apagar</button>
            </td>`;
        };


        /**
         * Atualiza a visualização (Grid ou Tabela) para o módulo atual.
         */
        const updateModuleView = (items, module) => {
            const moduleInfo = MODULE_MAP[module];
            const container = document.getElementById(moduleInfo.containerId);
            
            container.innerHTML = '';
            container.classList.remove('grid', 'overflow-x-auto');
            
            if (!Array.isArray(items) || items.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center p-10 bg-white rounded-xl shadow border-l-4 border-orange-400">
                        <i data-lucide="${module === 'desenvolvedores' ? 'code' : module === 'clientes' ? 'briefcase' : module === 'projetos' ? 'kanban' : 'server'}" class="w-12 h-12 mx-auto text-orange-500 mb-3"></i>
                        <p class="text-lg text-gray-600">Nenhum(a) ${moduleInfo.singular} cadastrado(a).</p>
                        <button onclick="openModal('${module}')" class="mt-4 text-orange-600 hover:text-orange-800 font-medium">
                            Adicionar o primeiro agora!
                        </button>
                    </div>
                `;
            } else if (currentView === 'grid') {
                container.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'lg:grid-cols-3', 'xl:grid-cols-4', 'gap-6');
                items.forEach(item => {
                    container.insertAdjacentHTML('beforeend', renderCard(item, module));
                });
            } else { // 'table'
                container.innerHTML = renderTable(items, module);
            }
            lucide.createIcons();
        };

        // --- LÓGICA DE DADOS E EVENTOS ---

        /**
         * Busca e exibe a lista de itens para o módulo atual.
         */
        const loadModuleData = async (module) => {
            const moduleInfo = MODULE_MAP[module];
            const container = document.getElementById(moduleInfo.containerId);
            
            // Limpa o conteúdo e mostra o indicador de carregamento
            container.innerHTML = ''; 
            loadingIndicator.classList.remove('hidden');

            try {
                // GET ALL: /desenvolvedores
                const items = await apiCall(moduleInfo.endpoint, { method: 'GET' });
                updateModuleView(items, module);
            } catch (error) {
                 // A mensagem de erro já foi exibida pelo apiCall
                container.innerHTML = `
                    <div class="col-span-full text-center p-10 bg-red-100 rounded-xl shadow border-l-4 border-red-500">
                        <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto text-red-600 mb-3"></i>
                        <p class="text-lg text-red-700">Não foi possível carregar os dados para ${moduleInfo.singular}s.</p>
                        <p class="text-sm text-red-500">Verifique se o backend está ativo em <code>${API_BASE_URL}</code> e o endpoint <code>/${moduleInfo.endpoint}</code> está correto.</p>
                    </div>
                `;
            } finally {
                 loadingIndicator.classList.add('hidden');
            }
        };

        /**
         * Alterna o conteúdo principal entre os módulos.
         */
        const switchTab = (tabId) => {
            currentTab = tabId;
            
            // 1. Atualiza o título e esconde/mostra conteúdo
            tabContents.forEach(content => content.classList.add('hidden'));
            const tabElement = document.getElementById(`tab-${tabId}`);
            if (tabElement) {
                // A primeira letra deve ser maiúscula (e.g. 'Desenvolvedores')
                pageTitle.textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1);
                tabElement.classList.remove('hidden');
            }

            // 2. Atualiza a classe ativa da sidebar
            navItems.forEach(item => item.classList.remove('active-tab'));
            const activeItem = document.querySelector(`.nav-item[data-tab="${tabId}"]`);
            if (activeItem) {
                activeItem.classList.add('active-tab');
            }

            // 3. Configura o botão "Adicionar Novo" 
            addDevBtn.onclick = () => openModal(tabId);
            
            // 4. Carrega os dados
            loadModuleData(tabId);
        };

        // --- MODAL E FORMS CRUD ---

        /**
         * Gera o HTML dos campos do formulário dinamicamente.
         * VERSÃO FINALIZADA: Correção da ordem dos campos de Endereço.
         */
        const generateFormHTML = (module) => {
            const moduleInfo = MODULE_MAP[module];
            let outputHtml = '';
            
            // Variáveis para armazenar o HTML separadamente
            let mainFieldsHtml = '';
            let addressFieldsHtml = '';

            // 1. CRITICAL FIX: Adiciona o campo oculto 'id' que é necessário pela openModal.
            outputHtml += '<input type="hidden" name="id" value="">';

            // --- INÍCIO DO WRAPPER DE COLUNAS ---
            outputHtml += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            
            // 2. Processar campos específicos do módulo (formFields) PRIMEIRO
            moduleInfo.formFields.forEach(field => {
                const baseProps = `name="${field.sql}" class="input-field" ${field.required ? 'required' : ''}`;
                let inputHtml = '';
                let wrapperClasses = ''; 

                if (field.type === 'text' || field.type === 'email' || field.type === 'number' || field.type === 'url' || field.type === 'date') {
                    const stepAttr = field.type === 'number' && field.step ? `step="${field.step}"` : '';
                    const valueAttr = field.type === 'number' && field.value ? `value="${field.value}"` : '';
                    
                    // Special handling for secret field: render as password with reveal button
                    if (field.sql === 'referencia_senha') {
                        inputHtml = `<div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}:</label>
                        <div class="relative">
                            <input type="password" ${baseProps} ${stepAttr} ${valueAttr} id="field-${field.sql}">
                            <button type="button" class="toggle-secret-btn absolute right-2 top-1/2 transform -translate-y-1/2 text-sm text-orange-600 hover:text-orange-800">Mostrar</button>
                        </div>
                        ${field.notes ? `<p class="mt-1 text-xs text-gray-500">${field.notes}</p>` : ''}
                    </div>`;
                    } else {
                        inputHtml = `<div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}:</label>
                        <input type="${field.type}" ${baseProps} ${stepAttr} ${valueAttr}>
                        ${field.notes ? `<p class="mt-1 text-xs text-gray-500">${field.notes}</p>` : ''}
                    </div>`;
                    }

                } else if (field.type === 'textarea') {
                    // Textareas e notas devem ocupar duas colunas (full width)
                    wrapperClasses = 'md:col-span-2';
                    inputHtml = `<div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}:</label>
                        <textarea ${baseProps} rows="3"></textarea>
                        ${field.notes ? `<p class="mt-1 text-xs text-gray-500">${field.notes}</p>` : ''}
                    </div>`;

                } else if (field.type === 'checkbox') {
                    inputHtml = `<div class="flex items-center">
                        <input type="checkbox" id="${field.sql}" ${baseProps} class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                        <label for="${field.sql}" class="text-sm font-medium text-gray-700">${field.label}</label>
                        ${field.notes ? `<p class="mt-1 text-xs text-gray-500 ml-4">${field.notes}</p>` : ''}
                    </div>`;

                } else if (field.type === 'select') {
                    let optionsHtml = '';
                    let disabled = '';
                    
                    if (field.remoteOptions) {
                        // Trata selects que carregarão opções via API
                        optionsHtml = `<option value="" disabled selected>Carregando ${field.label}...</option>`;
                        disabled = 'disabled';
                    } else if (field.options && Array.isArray(field.options)) {
                        // Trata selects com opções fixas (local)
                        optionsHtml = `<option value="" disabled selected>Selecione</option>` + 
                                       field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    } else {
                        // Fallback
                        optionsHtml = `<option value="" disabled selected>Nenhuma opção disponível</option>`;
                        disabled = 'disabled';
                    }

                    inputHtml = `<div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}:</label>
                        <select ${baseProps} ${disabled}>
                            ${optionsHtml}
                        </select>
                        ${field.notes ? `<p class="mt-1 text-xs text-gray-500">${field.notes}</p>` : ''}
                    </div>`;
                }

                mainFieldsHtml += `<div class="mb-4 ${wrapperClasses}">${inputHtml}</div>`;
            });
            
            // Adiciona os campos principais à saída HTML
            outputHtml += mainFieldsHtml;


            // 3. Processar campos de endereço (addressFields) POR ÚLTIMO
            if (moduleInfo.addressFields) {
                // Fechamos a grade dos campos principais e iniciamos a seção de endereço
                addressFieldsHtml += '</div><hr class="my-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                const addressFields = [
                    { label: "CEP", sql: "cep", type: "text", required: true },
                    { label: "Rua", sql: "rua", type: "text", required: true },
                    { label: "Número", sql: "numero", type: "text" },
                    { label: "Bairro", sql: "bairro", type: "text", required: true },
                    { label: "Cidade", sql: "cidade", type: "text", required: true },
                    { label: "Estado", sql: "estado", type: "text", required: true },
                    { label: "País", sql: "pais", type: "text", required: true },
                ];
                addressFields.forEach(field => {
                    addressFieldsHtml += `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}:</label>
                            <input type="${field.type}" name="${field.sql}" data-address-field
                                class="input-field" ${field.required ? 'required' : ''}>
                        </div>
                    `;
                });
                
                // Adiciona os campos de endereço à saída HTML
                outputHtml += addressFieldsHtml;
            }
            
            // --- FIM DO WRAPPER DE COLUNAS ---
            outputHtml += '</div>';
            
            return outputHtml;
        };

        /**
         * Abre o modal no modo Adicionar ou Edição.
         */
        const openModal = async (module, id = null) => {
            const moduleInfo = MODULE_MAP[module];
            editingItemId = id;
            itemForm.setAttribute('data-module', module);
            
            console.log(`[LOG-MODAL] Iniciando openModal para módulo: ${module}, ID: ${id}`); // LOG 4
            
            // 1. Gera e injeta o formulário dinâmico
            formFieldsContainer.innerHTML = generateFormHTML(module);
            lucide.createIcons(); 

            // 2. Abre o modal IMEDIATAMENTE. O conteúdo será preenchido a seguir
            // Esta correção é essencial para evitar o travamento do modal.
            mainModal.classList.remove('hidden'); 
            console.log(`[LOG-MODAL] Modal principal exibido.`); // LOG 5
            
            // 3. Configura título e botão
            let itemToEdit = {};
            const isEditing = !!id;
            
            if (isEditing) {
                // MODO EDIÇÃO: Define título de carregamento e busca dados
                modalTitle.textContent = `Carregando ${moduleInfo.singular}...`;
                submitFormText.textContent = `Atualizar ${moduleInfo.singular}`;
                try {
                    // Tenta buscar o item para edição
                    itemToEdit = await apiCall(`${moduleInfo.endpoint}/${id}`, { method: 'GET' });
                    console.log(`[LOG-MODAL] Dados do item em edição carregados com sucesso.`); // LOG 6
                    // Se for o módulo de infraestrutura, tenta decifrar a senha via endpoint dedicado
                    try {
                        if (module === 'infraestrutura') {
                            console.log('[LOG-MODAL] Solicitando decriptação do campo referencia_senha...');
                            const decResp = await apiCall(`${moduleInfo.endpoint}/decrypt/${id}`, { method: 'GET' });
                            if (decResp && decResp.secret) {
                                itemToEdit.referencia_senha = decResp.secret;
                                console.log('[LOG-MODAL] Senha descriptografada carregada no item.');
                            }
                        }
                    } catch (decErr) {
                        console.warn('[LOG-MODAL] Não foi possível decriptar a senha (permanece mascarada).', decErr);
                        // Mantém o valor mascarado; não interrompe o fluxo
                    }
                } catch (error) {
                    // Se falhar ao carregar, fecha o modal e retorna
                    console.error(`[LOG-MODAL] ERRO ao carregar item em edição, fechando modal.`, error); // LOG 7
                    mainModal.classList.add('hidden');
                    return;
                }
            } else {
                // MODO ADIÇÃO
                modalTitle.textContent = `Adicionar Novo ${moduleInfo.singular}`;
                submitFormText.textContent = `Salvar ${moduleInfo.singular}`;
                itemForm.reset();
            }
            
            // --- INÍCIO DO PREENCHIMENTO E CARREGAMENTO DE OPÇÕES ---
            
            // 4. Preenche o ID escondido (PK real)
            itemForm.querySelector('[name="id"]').value = itemToEdit[moduleInfo.pk] || '';

            const remoteLoadPromises = [];

            moduleInfo.formFields.forEach(field => {
                const element = itemForm.querySelector(`[name="${field.sql}"]`);
                const value = itemToEdit[field.sql];

                if (element) {
                    if (field.remoteOptions) {
                        // 4.1. Carrega opções remotas em paralelo (Clientes/Desenvolvedores)
                        remoteLoadPromises.push(fillRemoteSelect(field, value));
                    } else if (value !== undefined) {
                        // 4.2. Preenche campos normais
                        if (field.type === 'checkbox') {
                            element.checked = !!value;
                        } else {
                            // Melhoria: Garante que o input[type=date] recebe o formato YYYY-MM-DD
                            if (field.type === 'date' && value) {
                                element.value = value.split('T')[0];
                            } else {
                                element.value = value;
                            }
                        }
                    }
                }
            });
            
            console.log(`[LOG-MODAL] ${remoteLoadPromises.length} campos remotos encontrados.`) // LOG 8

            // 5. Aguarda o preenchimento de todas as opções remotas
            if (remoteLoadPromises.length > 0) {
                 // Mostra indicador de carregamento
                const loadingModal = document.createElement('div');
                // Z-50 garante que o overlay fique por cima do form
                loadingModal.className = 'absolute inset-0 bg-white bg-opacity-80 z-50 flex items-center justify-center rounded-xl';
                loadingModal.innerHTML = '<i data-lucide="loader-2" class="w-8 h-8 mr-2 animate-spin primary-text"></i> <span class="text-gray-700">Carregando listas...</span>';
                
                // Anexa o overlay ao div principal do modal (o pai do itemForm)
                itemForm.parentElement.appendChild(loadingModal); 
                lucide.createIcons();
                
                console.log(`[LOG-MODAL] Iniciando carregamento Promise.all de listas remotas.`); // LOG 9
                
                try {
                    // Aguarda todas as chamadas de API de Clientes e Desenvolvedores
                    await Promise.all(remoteLoadPromises);
                    console.log(`[LOG-MODAL] Todas as listas remotas carregadas com sucesso!`); // LOG 10
                } catch (e) {
                    console.error("[LOG-MODAL] ERRO durante Promise.all (lista de opções):", e); // LOG 11
                    // A função fillRemoteSelect já tratou o erro no selectbox
                } finally {
                    loadingModal.remove(); // Remove o indicador após carregar ou falhar
                    console.log(`[LOG-MODAL] Overlay de carregamento removido.`); // LOG 12
                }
            }
            
            // --- Anexa listeners para botões de mostrar/ocultar senha (se existirem) ---
            (() => {
                const toggleButtons = itemForm.querySelectorAll('.toggle-secret-btn');
                toggleButtons.forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const input = itemForm.querySelector('[name="referencia_senha"]');
                        const module = itemForm.getAttribute('data-module') || currentTab;
                        const id = itemForm.querySelector('[name="id"]') ? itemForm.querySelector('[name="id"]').value : '';

                        if (!input) return;

                        // Guarda estado do texto original para restaurar depois
                        const originalText = btn.textContent;

                        // Helper para ativar spinner no botão
                        const setLoading = (on) => {
                            if (on) {
                                btn.disabled = true;
                                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-1 animate-spin"></i>Carregando';
                                try { lucide.createIcons(); } catch (e) { /* ok */ }
                            } else {
                                btn.disabled = false;
                                btn.textContent = originalText;
                            }
                        };

                        // Se estiver oculto, tenta decriptar (quando aplicável) e mostra
                        if (input.type === 'password') {
                            // Se o campo está vazio ou contém o placeholder mascarado, tenta decriptar
                            if (!input.value || input.value === '*** CRIPTOGRAFADO ***') {
                                if (!id) {
                                    // Nada para decriptar (novo item)
                                } else {
                                    try {
                                        setLoading(true);
                                        const resp = await apiCall(`${moduleInfo.endpoint}/decrypt/${id}`, { method: 'GET' });
                                        if (resp && resp.secret) {
                                            input.value = resp.secret;
                                        } else {
                                            showAlert('Não foi possível recuperar a senha descriptografada.', 'error');
                                        }
                                    } catch (err) {
                                        console.warn('Falha ao decriptar via botão:', err);
                                        showAlert('Falha ao recuperar senha. Verifique permissões.', 'error');
                                        setLoading(false);
                                        return;
                                    } finally {
                                        setLoading(false);
                                    }
                                }
                            }
                            input.type = 'text';
                            btn.textContent = 'Ocultar';
                        } else {
                            input.type = 'password';
                            btn.textContent = 'Mostrar';
                        }
                    });
                });
            })();
            
            // 6. Preenche campos de endereço (endereco_obj)
            if (moduleInfo.addressFields && itemToEdit.endereco_obj) {
                const address = itemToEdit.endereco_obj;
                Object.keys(address).forEach(key => {
                    const element = itemForm.querySelector(`[name="${key}"][data-address-field]`);
                    if (element && address[key] !== undefined) {
                        element.value = address[key];
                    }
                });
            }

            // 7. Atualiza o título final
            const primaryName = itemToEdit.nome || itemToEdit.titulo || itemToEdit.descricao || (id ? ('ID: ' + id) : '');
            modalTitle.textContent = isEditing ? `Editar ${moduleInfo.singular}: ${primaryName}` : `Adicionar Novo ${moduleInfo.singular}`;
            
            console.log(`[LOG-MODAL] Finalizado openModal para ${module}.`); // LOG 13
        };

        /**
         * Processa a submissão do formulário (POST ou PUT).
         */
        const submitFormHandler = async (e) => {
            e.preventDefault();
            
            const submitBtnElement = document.getElementById('submit-form-btn');
            submitBtnElement.disabled = true;
            const processingSpan = document.getElementById('submit-form-text');
            if (processingSpan) {
                processingSpan.textContent = 'Processando...';
            } else {
                submitBtnElement.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 mr-2 animate-spin"></i> <span id="submit-form-text">Processando...</span>';
            }
            lucide.createIcons();

            const module = itemForm.getAttribute('data-module');
            const moduleInfo = MODULE_MAP[module];
            const formData = new FormData(itemForm);
            const itemData = {};
            let addressData = {};

            // 1. Coleta e formata os dados
            const pkValue = formData.get('id'); // ID/PK do item, se houver
            
            for (let [key, value] of formData.entries()) {
                const element = itemForm.querySelector(`[name="${key}"]`);
                
                // Ignora o campo 'id' (PK) se for nulo (modo criação)
                if (key === 'id') continue; 
                
                if (element && element.getAttribute('data-address-field') !== null) {
                    // 1.1 Coleta dados de Endereço (objeto aninhado)
                    addressData[key] = value;
                } else if (element && element.type === 'checkbox') {
                    // 1.2 Trata Checkboxes
                    itemData[key] = element.checked;
                } else if (key === 'taxa_horaria' || key === 'orcamento') {
                    // 1.3 Trata Números Flutuantes
                    itemData[key] = parseFloat(value) || 0;
                } else {
                    // 1.4 Outros campos
                    itemData[key] = value;
                }
            }

            // 2. Anexa endereço se o módulo precisar (mesmo que alguns campos estejam vazios)
            if (moduleInfo.addressFields) {
                // Remove campos de endereço vazios, exceto se forem obrigatórios (cidade/estado)
                Object.keys(addressData).forEach(key => {
                    const value = addressData[key].trim();
                    if (!value && key !== 'cidade' && key !== 'estado') {
                        delete addressData[key];
                    }
                });
                itemData.endereco_obj = addressData;
            }

            // 3. Define o método e endpoint
            const method = pkValue ? 'PUT' : 'POST';
            // PUT: /desenvolvedores/123 | POST: /desenvolvedores
            const endpoint = pkValue ? `${moduleInfo.endpoint}/${pkValue}` : moduleInfo.endpoint;
            
            try {
                await apiCall(endpoint, {
                    method: method,
                    body: JSON.stringify(itemData)
                });
                
                showAlert(`${moduleInfo.singular} ${pkValue ? 'atualizado(a)' : 'criado(a)'} com sucesso!`, 'success');
                
                // Reset State and UI
                editingItemId = null;
                mainModal.classList.add('hidden');
                itemForm.reset();
                await loadModuleData(currentTab); // Recarrega a lista

            } catch (error) {
                // O showAlert já foi chamado pelo apiCall
            } finally {
                // Reabilita o botão
                submitBtnElement.disabled = false;
                const finalSpan = document.getElementById('submit-form-text');
                const finalText = `${pkValue ? 'Atualizar' : 'Salvar'} ${moduleInfo.singular}`;
                if (finalSpan) {
                    finalSpan.textContent = finalText;
                } else {
                    submitBtnElement.innerHTML = `<i data-lucide="save" class="w-5 h-5 mr-2"></i> <span id="submit-form-text">${finalText}</span>`;
                }
                lucide.createIcons();
            }
        };

        /**
         * Função para deletar um item.
         */
        const deleteItem = async () => {
            const { id, nome, endpoint } = itemToDelete;
            const moduleInfo = MODULE_MAP[currentTab];
            
            confirmModal.classList.add('hidden');
            itemToDelete.id = null;

            try {
                // DELETE: /desenvolvedores/123
                await apiCall(`${endpoint}/${id}`, { method: 'DELETE' });
                
                showAlert(`${moduleInfo.singular} '${nome}' excluído(a) com sucesso.`, 'success');
                await loadModuleData(currentTab); 
            } catch (error) {
                showAlert(`Falha ao excluir o ${moduleInfo.singular} '${nome}'.`, 'error');
            }
        };
        
        // --- LISTENERS DE EVENTOS ---

        // 1. Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); 
            switchTab('desenvolvedores'); 
        });

        // 2. Navegação na Sidebar
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const tab = item.getAttribute('data-tab');
                switchTab(tab);
            });
        });

        // 2.5 Logout (remove token e redireciona para login)
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                try { localStorage.removeItem('access_token'); } catch (e) { /* ignore */ }
                window.location.href = './login.html';
            });
        }

        // 3. Fechamento dos Modals
        closeModalBtn.addEventListener('click', () => mainModal.classList.add('hidden'));
        cancelDeleteBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
        executeDeleteBtn.addEventListener('click', deleteItem);
        
        // 4. Submissão do Formulário
        itemForm.addEventListener('submit', submitFormHandler);

        // 5. Listener de Delegação para Editar/Apagar
        tabContents.forEach(container => {
            container.addEventListener('click', (e) => {
                const target = e.target;
                const button = target.closest('.edit-btn, .delete-btn');
                
                if (button) {
                    const id = button.getAttribute('data-item-id');
                    const name = button.getAttribute('data-item-name');
                    const module = currentTab;
                    
                    if (id && id !== 'undefined' && name) {
                        if (button.classList.contains('edit-btn')) {
                            // O ID aqui é a chave primária (e.g., id_desenvolvedor)
                            openModal(module, id); 
                        } else if (button.classList.contains('delete-btn')) {
                            const moduleInfo = MODULE_MAP[module];
                            itemToDelete = { id: id, nome: name, endpoint: moduleInfo.endpoint };
                            confirmModalText.querySelector('span').textContent = `'${name}' (ID: ${id})`;
                            confirmModal.classList.remove('hidden');
                        }
                    } else {
                        showAlert('Erro: O ID do item está faltando no registro da API. Verifique se o backend está retornando a chave primária corretamente.', 'error');
                    }
                }
            });
        });

        // 6. Listener para o Toggle de Visualização
        toggleGridBtn.addEventListener('click', () => {
            if (currentView === 'grid') return;
            currentView = 'grid';
            toggleGridBtn.classList.add('primary-bg', 'text-white');
            toggleGridBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            toggleTableBtn.classList.remove('primary-bg', 'text-white');
            toggleTableBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            loadModuleData(currentTab);
        });
        
        toggleTableBtn.addEventListener('click', () => {
            if (currentView === 'table') return;
            currentView = 'table';
            toggleTableBtn.classList.add('primary-bg', 'text-white');
            toggleTableBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            toggleGridBtn.classList.remove('primary-bg', 'text-white');
            toggleGridBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            loadModuleData(currentTab);
        });
        
    </script>
</body>
</html>